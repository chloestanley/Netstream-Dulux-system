@model IEnumerable<ApplicationUser>

@{
    ViewData["Title"] = "Admin - User Management";
}

<div class="container mt-4">
    <div class="card shadow rounded-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">👥 @ViewData["Title"]</h3>
            <a href="@Url.Action("DownloadAllUsersAsCsv", "Admin")" class="btn btn-light btn-sm">
                ⬇️ Download All User Data
            </a>
        </div>

        <div class="card-body">
            <!-- Search Input -->
            <div class="mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="🔍 Search by UserName or Email" onkeyup="filterUsers()" />
            </div>

            <!-- Total Users Count -->
            <div class="mb-3">
                <strong>Total Users: <span id="totalUsers">@Model.Count()</span></strong>
            </div>

            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>👤 UserName</th>
                                <th>📧 Email</th>
                                <th>⏰ Last Login</th>
                                <th>🚪 Last Logout</th>
                                <th>📥 Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            @foreach (var user in Model.Select((user, index) => new { user, index }))
                            {
                                <tr>
                                    <td>@(user.index + 1)</td>
                                    <td>@user.user.UserName</td>
                                    <td>@user.user.Email</td>
                                    <td class="loginTime">@user.user.LastLoginTime</td>
                                    <td class="logoutTime">@user.user.LastLogoutTime</td>
                                    <td>
                                        <a href="@Url.Action("DownloadPersonalData", "Admin", new { userId = user.user.Id })" class="btn btn-info btn-sm">
                                            📄 Download Data
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center mb-0">
                    ⚠️ No users found.
                </div>
            }
        </div>
    </div>
</div>

<script>
    function filterUsers() {
        var input = document.getElementById("searchInput");
        var filter = input.value.toLowerCase();
        var table = document.getElementById("userTableBody");
        var rows = table.getElementsByTagName("tr");
        var visibleCount = 0;

        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName("td");
            var userName = cells[1].textContent.toLowerCase();
            var email = cells[2].textContent.toLowerCase();

            if (userName.includes(filter) || email.includes(filter)) {
                rows[i].style.display = "";
                visibleCount++;
            } else {
                rows[i].style.display = "none";
            }
        }

        document.getElementById("totalUsers").textContent = visibleCount;
    }

    function formatDateTime(dateTimeString) {
        if (!dateTimeString || dateTimeString.trim() === "") return "";
        var date = new Date(dateTimeString);
        if (isNaN(date.getTime())) return dateTimeString;
        var year = date.getFullYear();
        var month = ("0" + (date.getMonth() + 1)).slice(-2);
        var day = ("0" + date.getDate()).slice(-2);
        var hours = ("0" + date.getHours()).slice(-2);
        var minutes = ("0" + date.getMinutes()).slice(-2);
        var seconds = ("0" + date.getSeconds()).slice(-2);
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    document.addEventListener("DOMContentLoaded", function () {
        var loginCells = document.querySelectorAll(".loginTime");
        var logoutCells = document.querySelectorAll(".logoutTime");

        loginCells.forEach(function (cell) {
            cell.textContent = formatDateTime(cell.textContent);
        });

        logoutCells.forEach(function (cell) {
            cell.textContent = formatDateTime(cell.textContent);
        });
    });
</script>
